<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ÙØ±Ù… Ø¢Ú¯Ù‡ÛŒ Ø¨Ø§Ù†Ú© Ø®ÙˆØ¯Ø±Ùˆ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
      :root {
        --bg1: #0f172a;
        --bg2: #0b1220;
        --card: rgba(255, 255, 255, 0.06);
        --input-bg: #101a2e;
        --border: rgba(255, 255, 255, 0.18);
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #22c55e;
        --danger: #ef4444;
        --radius: 14px;
      }

      * {
        box-sizing: border-box;
        font-family: "IRANSans", "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        padding: 16px;
        background: linear-gradient(135deg, var(--bg2), var(--bg1));
        min-height: 100vh;
        color: var(--text);
        display: flex;
        justify-content: center;
      }

      .wrap {
        width: 100%;
        max-width: 800px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 22px;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(8px);
      }

      h1 {
        text-align: center;
        margin: 0 0 20px;
        font-size: 22px;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 18px;
        flex-wrap: wrap;
      }

      .tab {
        flex: 1;
        padding: 12px;
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        min-width: 120px;
      }

      .tab.active {
        color: var(--accent);
        border-color: var(--accent);
        font-weight: bold;
      }

      .section {
        background: var(--input-bg);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 18px;
      }

      .grid {
        display: grid;
        gap: 16px;
        grid-template-columns: 1fr 1fr;
        margin-bottom: 14px;
      }

      @media (max-width: 600px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border-radius: var(--radius);
        background: #0b1526;
        border: 1px solid var(--border);
        color: var(--text);
        outline: none;
        font-size: 15px;
      }

      input:focus,
      textarea:focus,
      select:focus {
        border-color: var(--accent);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      label {
        margin-bottom: 5px;
        font-size: 14px;
        display: block;
      }

      .muted {
        color: var(--muted);
        font-size: 12px;
        margin-top: 4px;
      }

      .err {
        color: var(--danger);
        min-height: 16px;
        font-size: 12px;
        margin-top: 4px;
      }

      .row {
        display: flex;
        gap: 12px;
        margin-top: 16px;
      }

      button {
        flex: 1;
        padding: 14px;
        background: var(--accent);
        border: none;
        border-radius: var(--radius);
        font-weight: bold;
        cursor: pointer;
        color: white;
        font-size: 16px;
        transition: 0.2s;
      }

      button:hover {
        background: #1ea34d;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Ø¢Ù¾Ù„ÙˆØ¯Ø± Ø¹Ú©Ø³ */
      .upload-area {
        border: 2px dashed var(--border);
        border-radius: var(--radius);
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        margin-top: 12px;
        background: rgba(0, 0, 0, 0.2);
      }

      .upload-area:hover {
        border-color: var(--accent);
        background: rgba(34, 197, 94, 0.05);
      }

      .upload-area.dragover {
        border-color: var(--accent);
        background: rgba(34, 197, 94, 0.1);
        transform: scale(1.02);
      }

      #file-input {
        display: none;
      }

      .preview-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        margin-top: 16px;
      }

      .preview-item {
        position: relative;
        border-radius: var(--radius);
        overflow: hidden;
        aspect-ratio: 1;
        border: 2px solid var(--border);
        background: #000;
      }

      .preview-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .remove-btn {
        position: absolute;
        top: 6px;
        right: 6px;
        background: var(--danger);
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 18px;
        line-height: 1;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        transition: 0.2s;
      }

      .remove-btn:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      /* Dialog */
      .dialog {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 1000;
      }

      .box {
        background: var(--input-bg);
        border: 1px solid var(--border);
        padding: 24px;
        border-radius: var(--radius);
        width: 100%;
        max-width: 550px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .preview {
        border: 1px dashed var(--border);
        padding: 16px;
        border-radius: var(--radius);
        white-space: pre-line;
        color: var(--text);
        background: rgba(0, 0, 0, 0.3);
      }

      .loading {
        display: none;
        text-align: center;
        color: var(--accent);
        margin-top: 12px;
        font-size: 14px;
      }

      .photo-count {
        display: inline-block;
        background: var(--accent);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-right: 8px;
      }

      .debug-info {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--danger);
        border-radius: var(--radius);
        padding: 12px;
        margin-top: 12px;
        font-size: 12px;
        color: var(--danger);
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <h1>ğŸš— Ø¨Ø§Ù†Ú© Ø®ÙˆØ¯Ø±Ùˆ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†</h1>

        <div class="tabs">
          <div class="tab active" data-cat="ÙØ±ÙˆØ´ Ú©Ø§Ø±Ú©Ø±Ø¯Ù‡">ÙØ±ÙˆØ´ Ú©Ø§Ø±Ú©Ø±Ø¯Ù‡</div>
          <div class="tab" data-cat="ÙØ±ÙˆØ´ Ù‡Ù…Ú©Ø§Ø±ÛŒ">ÙØ±ÙˆØ´ Ù‡Ù…Ú©Ø§Ø±ÛŒ</div>
          <div class="tab" data-cat="Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø±ÛŒØ¯">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø±ÛŒØ¯</div>
          <div class="tab" data-cat="ÙØ±ÙˆØ´ ØµÙØ±">ÙØ±ÙˆØ´ ØµÙØ±</div>
        </div>

        <div class="section">
          <!-- Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ Ùˆ Ø³Ø§Ù„ -->
          <div class="grid">
            <div>
              <label>Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ *</label>
              <input id="car" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù¾Ú˜Ùˆ 206 ÛŒØ§ Sonata 2018" />
              <div class="err" id="e_car"></div>
            </div>

            <div>
              <label>Ø³Ø§Ù„ Ø³Ø§Ø®Øª *</label>
              <input id="year" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Û´Û°Û± ÛŒØ§ 1401 ÛŒØ§ 2018" />
              <div class="err" id="e_year"></div>
            </div>
          </div>

          <!-- Ø±Ù†Ú¯ Ùˆ Ú©Ø§Ø±Ú©Ø±Ø¯ -->
          <div class="grid">
            <div>
              <label>Ø±Ù†Ú¯ *</label>
              <input id="color" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø³ÙÛŒØ¯" />
              <div class="err" id="e_color"></div>
            </div>

            <div>
              <label>Ú©Ø§Ø±Ú©Ø±Ø¯ (Ú©ÛŒÙ„ÙˆÙ…ØªØ±) *</label>
              <input id="km" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 45000" />
              <div class="err" id="e_km"></div>
            </div>
          </div>

          <!-- Ø¨ÛŒÙ…Ù‡ Ùˆ Ú¯ÛŒØ±Ø¨Ú©Ø³ -->
          <div class="grid">
            <div>
              <label>Ù…Ù‡Ù„Øª Ø¨ÛŒÙ…Ù‡ (Ù…Ø§Ù‡)</label>
              <input id="insurance" inputmode="numeric" placeholder="Ù…Ø«Ù„Ø§Ù‹ 6" />
              <div class="err" id="e_ins"></div>
            </div>
            <div>
              <label>Ú¯ÛŒØ±Ø¨Ú©Ø³</label>
              <select id="gear">
                <option value="">â€” Ø®Ø§Ù„ÛŒ â€”</option>
                <option>Ø§ØªÙˆÙ…Ø§Øª</option>
                <option>Ø¯Ù†Ø¯Ù‡â€ŒØ§ÛŒ</option>
              </select>
            </div>
          </div>

          <!-- Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ -->
          <div class="grid">
            <div>
              <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ *</label>
              <input
                id="phone"
                inputmode="tel"
                placeholder="Ù…Ø«Ù„Ø§Ù‹: 09123456789"
              />
              <div class="err" id="e_phone"></div>
            </div>
          </div>

          <!-- Ù‚ÛŒÙ…Øª -->
          <label>Ù‚ÛŒÙ…Øª (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†) *</label>
          <input
            id="price"
            inputmode="decimal"
            placeholder="Ù…Ø«Ù„Ø§Ù‹: 80 ÛŒØ§ 2500 ÛŒØ§ 120.5"
          />
          <div id="price_hint" class="muted"></div>
          <div class="err" id="e_price"></div>

          <!-- ØªÙˆØ¶ÛŒØ­Ø§Øª -->
          <label style="margin-top: 12px">ØªÙˆØ¶ÛŒØ­Ø§Øª (ÙˆØ¶Ø¹ÛŒØª Ø¨Ø¯Ù†Ù‡ØŒ Ø±Ù†Ú¯â€ŒØ´Ø¯Ú¯ÛŒØŒ ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ø³ÛŒâ€ŒÙ‡Ø§ØŒ ÙˆØ¶Ø¹ÛŒØª ÙÙ†ÛŒØŒ Ù„Ø§Ø³ØªÛŒÚ©â€ŒÙ‡Ø§ Ùˆ ...)</label>
          <textarea id="desc" placeholder="Ø¯Ù„Ø®ÙˆØ§Ù‡"></textarea>

          <!-- Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³ -->
          <label style="margin-top: 16px">
            ğŸ“¸ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯Ø±Ùˆ 
            <span class="photo-count" id="photo-count">0/3</span>
          </label>
          <div class="upload-area" id="upload-area">
            <div style="font-size: 48px; margin-bottom: 8px">ğŸ“·</div>
            <div style="font-size: 16px; font-weight: bold;">Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</div>
            <div class="muted" style="margin-top: 8px">ÛŒØ§ ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ (Ø­Ø¯Ø§Ú©Ø«Ø± 3 Ø¹Ú©Ø³)</div>
          </div>
          <input type="file" id="file-input" accept="image/*" multiple />
          
          <div class="preview-container" id="preview-container"></div>
          <div class="err" id="e_photos"></div>
          <div class="loading" id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ú©Ø³â€ŒÙ‡Ø§...</div>

          <!-- Debug Info -->
          <div class="debug-info" id="debug-info"></div>

          <div class="row">
            <button id="submit">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ùˆ Ø§Ù†ØªØ´Ø§Ø± Ø¢Ú¯Ù‡ÛŒ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Dialog -->
    <div id="dlg" class="dialog">
      <div class="box">
        <h3 style="margin-top: 0;">Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø¢Ú¯Ù‡ÛŒ</h3>
        <div id="preview" class="preview"></div>

        <div class="row" style="margin-top: 16px">
          <button
            id="cancel"
            style="
              background: #0d172a;
              border: 1px solid var(--border);
              color: var(--text);
            "
          >
            Ø¨Ø±Ú¯Ø´Øª
          </button>
          <button id="confirm">âœ… ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ</button>
        </div>
      </div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      tg.expand();
      tg.ready();
      const $ = (s) => document.querySelector(s);

      // âœ… Debug logging
      function debugLog(message, data = null) {
        console.log(`[DEBUG] ${message}`, data || '');
        const debugInfo = $("#debug-info");
        debugInfo.style.display = "block";
        debugInfo.innerHTML += `<div>${message}</div>`;
        if (data) {
          debugInfo.innerHTML += `<pre>${JSON.stringify(data, null, 2).substring(0, 200)}...</pre>`;
        }
      }

      debugLog("WebApp initialized", { 
        platform: tg.platform,
        version: tg.version
      });

      /* CATEGORY */
      let category = "ÙØ±ÙˆØ´ Ú©Ø§Ø±Ú©Ø±Ø¯Ù‡";
      document.querySelectorAll(".tab").forEach((t) => {
        t.onclick = () => {
          document
            .querySelectorAll(".tab")
            .forEach((x) => x.classList.remove("active"));
          t.classList.add("active");
          category = t.dataset.cat;
          debugLog("Category changed", category);
        };
      });

      /* Photo Upload */
      const MAX_PHOTOS = 3;
      let photos = []; // Array of base64 strings

      const uploadArea = $("#upload-area");
      const fileInput = $("#file-input");
      const previewContainer = $("#preview-container");
      const photoCount = $("#photo-count");

      function updatePhotoCount() {
        photoCount.textContent = `${photos.length}/3`;
      }

      uploadArea.onclick = () => {
        if (photos.length >= MAX_PHOTOS) {
          setErr("photos", `Ø­Ø¯Ø§Ú©Ø«Ø± ${MAX_PHOTOS} Ø¹Ú©Ø³ Ù…Ø¬Ø§Ø² Ø§Ø³Øª.`);
          return;
        }
        fileInput.click();
      };

      // Drag and drop
      uploadArea.ondragover = (e) => {
        e.preventDefault();
        if (photos.length < MAX_PHOTOS) {
          uploadArea.classList.add("dragover");
        }
      };

      uploadArea.ondragleave = () => {
        uploadArea.classList.remove("dragover");
      };

      uploadArea.ondrop = (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        handleFiles(e.dataTransfer.files);
      };

      fileInput.onchange = (e) => {
        handleFiles(e.target.files);
      };

      // âœ… ØªØ§Ø¨Ø¹ ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ú©Ø³
      function compressImage(base64, maxWidth = 1200, quality = 0.8) {
        return new Promise((resolve) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø¨Ø¹Ø§Ø¯ Ø¬Ø¯ÛŒØ¯
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ base64 Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ±
            const compressed = canvas.toDataURL('image/jpeg', quality);
            debugLog(`Image compressed: ${img.width}x${img.height} â†’ ${width}x${height}`);
            resolve(compressed);
          };
          img.onerror = () => {
            debugLog("Image load error");
            resolve(base64); // Ø§Ú¯Ø± Ø®Ø·Ø§ Ø¯Ø§Ø¯ØŒ Ù‡Ù…ÙˆÙ† base64 Ø§ØµÙ„ÛŒ Ø±Ùˆ Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
          };
          img.src = base64;
        });
      }

      // âœ… Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø§ ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
      async function handleFiles(files) {
        setErr("photos", "");
        
        const remaining = MAX_PHOTOS - photos.length;
        if (remaining <= 0) {
          setErr("photos", `Ø­Ø¯Ø§Ú©Ø«Ø± ${MAX_PHOTOS} Ø¹Ú©Ø³ Ù…Ø¬Ø§Ø² Ø§Ø³Øª.`);
          return;
        }

        const filesToProcess = Array.from(files).slice(0, remaining);
        
        if (filesToProcess.length === 0) return;

        $("#loading").style.display = "block";
        debugLog(`Processing ${filesToProcess.length} files...`);

        let processed = 0;
        
        for (const file of filesToProcess) {
          if (!file.type.startsWith("image/")) {
            setErr("photos", "ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ±ÛŒ Ù…Ø¬Ø§Ø² Ù‡Ø³ØªÙ†Ø¯.");
            processed++;
            continue;
          }

          try {
            debugLog(`Reading file: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);

            // Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„
            const base64 = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (e) => resolve(e.target.result);
              reader.onerror = reject;
              reader.readAsDataURL(file);
            });

            // ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
            const compressed = await compressImage(base64, 1000, 0.8);
            const compressedSize = (compressed.length / 1024).toFixed(1);
            debugLog(`Compressed to ${compressedSize} KB`);
            
            photos.push(compressed);
            
          } catch (error) {
            debugLog("Error processing image", error.message);
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ú©Ø³:", error);
          }

          processed++;
          if (processed === filesToProcess.length) {
            renderPreviews();
            updatePhotoCount();
            $("#loading").style.display = "none";
            debugLog(`Total photos: ${photos.length}`);
          }
        }

        fileInput.value = "";
      }

      function renderPreviews() {
        previewContainer.innerHTML = "";
        photos.forEach((base64, index) => {
          const div = document.createElement("div");
          div.className = "preview-item";
          
          const img = document.createElement("img");
          img.src = base64;
          
          const btn = document.createElement("button");
          btn.className = "remove-btn";
          btn.textContent = "Ã—";
          btn.onclick = (e) => {
            e.stopPropagation();
            photos.splice(index, 1);
            renderPreviews();
            updatePhotoCount();
            setErr("photos", "");
            debugLog(`Photo removed. Remaining: ${photos.length}`);
          };
          
          div.appendChild(img);
          div.appendChild(btn);
          previewContainer.appendChild(div);
        });
      }

      /* helpers Ø®Ø·Ø§ */
      function setErr(id, msg) {
        const el = $("#e_" + id);
        if (el) el.textContent = msg || "";
      }

      function clearErrors() {
        ["car", "year", "color", "km", "ins", "phone", "price", "photos"].forEach((k) =>
          setErr(k, "")
        );
      }

      /* ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… ÙØ§Ø±Ø³ÛŒ/Ø¹Ø±Ø¨ÛŒ Ø¨Ù‡ Ù„Ø§ØªÛŒÙ† */
      function faToEnDigits(str) {
        if (!str) return "";
        const fa = "Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹";
        const ar = "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©";
        let out = "";
        for (let ch of String(str)) {
          const iFa = fa.indexOf(ch);
          const iAr = ar.indexOf(ch);
          if (iFa > -1) out += String(iFa);
          else if (iAr > -1) out += String(iAr);
          else out += ch;
        }
        return out;
      }

      /* ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„ÛŒÙˆÙ† â†’ ØªÙˆÙ…Ø§Ù† Ø®ÙˆØ§Ù†Ø§ */
      function formatFromMillion(input) {
        if (!input) return "";
        let val = parseFloat(faToEnDigits(String(input)).replace(",", "."));
        if (isNaN(val) || val <= 0) return "";

        val = Math.round(val * 10) / 10;
        let toman = Math.round(val * 1_000_000);
        let parts = [];

        if (toman >= 1_000_000_000) {
          let b = Math.floor(toman / 1_000_000_000);
          parts.push(b + " Ù…ÛŒÙ„ÛŒØ§Ø±Ø¯");
          toman %= 1_000_000_000;
        }
        if (toman >= 1_000_000) {
          let m = Math.floor(toman / 1_000_000);
          parts.push(m + " Ù…ÛŒÙ„ÛŒÙˆÙ†");
          toman %= 1_000_000;
        }
        if (toman >= 1_000) {
          let k = Math.floor(toman / 1_000);
          parts.push(k + " Ù‡Ø²Ø§Ø±");
        }
        return parts.join(" Ùˆ ") + " ØªÙˆÙ…Ø§Ù†";
      }

      function updatePriceHint() {
        const v = $("#price").value;
        const words = formatFromMillion(v);
        if (!v || !words) {
          $("#price_hint").textContent =
            "Ù…Ø«Ø§Ù„: 80 = 80 Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†ØŒ 120.5 = 120 Ù…ÛŒÙ„ÛŒÙˆÙ† Ùˆ 500 Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù†.";
        } else {
          $("#price_hint").textContent = words;
        }
      }

      /* ÙˆØ±ÙˆØ¯ÛŒ Ø³Ø§Ù„ */
      $("#year").addEventListener("input", () => {
        let v = $("#year").value;
        v = faToEnDigits(v);
        v = v.replace(/[^0-9]/g, "");
        if (v.length > 4) v = v.slice(0, 4);
        $("#year").value = v;
        setErr("year", "");
      });

      /* ÙˆØ±ÙˆØ¯ÛŒ Ù‚ÛŒÙ…Øª */
      $("#price").addEventListener("input", () => {
        let v = $("#price").value;
        v = faToEnDigits(v);
        v = v.replace(/[^0-9.,]/g, "");
        v = v.replace(",", ".");
        const parts = v.split(".");
        if (parts.length > 2) {
          v = parts[0] + "." + parts.slice(1).join("");
        }
        const p2 = v.split(".");
        if (p2[1] && p2[1].length > 1) {
          v = p2[0] + "." + p2[1].slice(0, 1);
        }
        $("#price").value = v;
        setErr("price", "");
        updatePriceHint();
      });

      /* Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ */
      $("#phone").addEventListener("input", () => {
        let v = faToEnDigits($("#phone").value);
        v = v.replace(/[^0-9]/g, "");
        $("#phone").value = v;
        setErr("phone", "");
      });

      /* Ú©Ø§Ø±Ú©Ø±Ø¯ */
      $("#km").addEventListener("input", () => {
        let v = faToEnDigits($("#km").value);
        v = v.replace(/[^0-9]/g, "");
        $("#km").value = v;
        setErr("km", "");
      });

      /* Ø¨ÛŒÙ…Ù‡ */
      $("#insurance").addEventListener("input", () => {
        let v = faToEnDigits($("#insurance").value);
        v = v.replace(/[^0-9]/g, "");
        $("#insurance").value = v;
        setErr("ins", "");
      });

      /* Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ */
      function validate(p) {
        clearErrors();
        let ok = true;

        p.year = faToEnDigits(p.year);
        p.km = faToEnDigits(p.km);
        p.insurance = faToEnDigits(p.insurance);
        p.phone = faToEnDigits(p.phone);
        p.price = faToEnDigits(p.price);

        if (
          !/^[Ø¢-ÛŒA-Za-z0-9\u06F0-\u06F9\u0660-\u0669\s]{2,40}$/.test(p.car) ||
          /[0-9\u06F0-\u06F9\u0660-\u0669]{5,}/.test(p.car)
        ) {
          setErr("car", "Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
          ok = false;
        }

        if (!/^(1[34]\d{2}|20[012]\d)$/.test(p.year)) {
          setErr("year", "Ø³Ø§Ù„ Ø³Ø§Ø®Øª Ø¨Ø§ÛŒØ¯ Û´ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.");
          ok = false;
        }

        if (!/^[Ø¢-ÛŒ\s]{1,12}$/.test(p.color)) {
          setErr("color", "Ø±Ù†Ú¯ ÙÙ‚Ø· Ø­Ø±ÙˆÙ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§Ø´Ø¯.");
          ok = false;
        }

        if (!/^[0-9]{1,6}$/.test(p.km)) {
          setErr("km", "Ú©Ø§Ø±Ú©Ø±Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
          ok = false;
        }

        if (p.insurance && !/^[0-9]{1,2}$/.test(p.insurance)) {
          setErr("ins", "Ù…Ù‡Ù„Øª Ø¨ÛŒÙ…Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
          ok = false;
        }

        if (!/^09[0-9]{9}$/.test(p.phone || "")) {
          setErr("phone", "Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.");
          ok = false;
        }

        if (!p.price || isNaN(parseFloat(p.price))) {
          setErr("price", "Ù‚ÛŒÙ…Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
          ok = false;
        }

        updatePriceHint();
        return ok;
      }

      /* Submit */
      $("#submit").onclick = () => {
        debugLog("Submit button clicked");
        
        const data = {
          category,
          car: $("#car").value.trim(),
          year: $("#year").value.trim(),
          color: $("#color").value.trim(),
          km: $("#km").value.trim(),
          insurance: $("#insurance").value.trim(),
          gear: $("#gear").value,
          phone: $("#phone").value.trim(),
          price: $("#price").value.trim(),
          desc: $("#desc").value.trim(),
          photos: photos,
        };

        debugLog("Form data collected", {
          category: data.category,
          car: data.car,
          photosCount: photos.length
        });

        if (!validate(data)) {
          debugLog("Validation failed");
          return;
        }

        const previewText = `Ø¯Ø³ØªÙ‡: ${data.category}
Ù†Ø§Ù… Ø®ÙˆØ¯Ø±Ùˆ: ${data.car}
Ø³Ø§Ù„: ${data.year}
Ø±Ù†Ú¯: ${data.color}
Ú©Ø§Ø±Ú©Ø±Ø¯: ${data.km} Ú©ÛŒÙ„ÙˆÙ…ØªØ±
Ù‚ÛŒÙ…Øª: ${formatFromMillion(data.price)}
Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³: ${data.phone}
${data.gear ? "Ú¯ÛŒØ±Ø¨Ú©Ø³: " + data.gear : ""}
${data.insurance ? "Ø¨ÛŒÙ…Ù‡: " + data.insurance + " Ù…Ø§Ù‡" : ""}
${data.desc ? "\nØªÙˆØ¶ÛŒØ­Ø§Øª:\n" + data.desc : ""}

ğŸ“¸ ØªØ¹Ø¯Ø§Ø¯ Ø¹Ú©Ø³: ${photos.length}`;

        $("#preview").textContent = previewText;
        $("#dlg").style.display = "flex";
        debugLog("Preview dialog opened");
      };

      $("#cancel").onclick = () => {
        $("#dlg").style.display = "none";
        debugLog("Dialog cancelled");
      };

      $("#confirm").onclick = () => {
        debugLog("Confirm button clicked");
        
        const payload = {
          category,
          car: $("#car").value.trim(),
          year: $("#year").value.trim(),
          color: $("#color").value.trim(),
          km: $("#km").value.trim(),
          insurance: $("#insurance").value.trim(),
          gear: $("#gear").value,
          phone: $("#phone").value.trim(),
          million_price: $("#price").value.trim(),
          desc: $("#desc").value.trim(),
          photos: photos,
        };

        const payloadStr = JSON.stringify(payload);
        const payloadSize = (payloadStr.length / 1024).toFixed(2);
        
        debugLog(`Payload size: ${payloadSize} KB`);
        debugLog(`Photos count: ${photos.length}`);
        
        // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªÙ„Ú¯Ø±Ø§Ù… Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ 64KB Ø§Ø³Øª
        if (payloadStr.length > 100000) {
          alert(`âŒ Ø­Ø¬Ù… Ø¯Ø§Ø¯Ù‡ Ø®ÛŒÙ„ÛŒ Ø²ÛŒØ§Ø¯ Ø§Ø³Øª (${payloadSize} KB).\nÙ„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ú©Ù…ØªØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.`);
          debugLog("Payload too large!", payloadSize);
          return;
        }

        try {
          debugLog("Sending data to Telegram...");
          tg.sendData(payloadStr);
          debugLog("Data sent successfully");
          tg.close();
        } catch (error) {
          debugLog("Send error", error.message);
          console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„:", error);
          alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡:\n" + error.message);
        }
      };

      updatePriceHint();
      updatePhotoCount();
      debugLog("Page loaded successfully");
    </script>
  </body>
</html>
